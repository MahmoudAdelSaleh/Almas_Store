<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>كاشير متكامل - نسخة GitHub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root {
            --primary-color: #007bff; --secondary-color: #343a40; --success-color: #28a745;
            --danger-color: #dc3545; --warning-color: #ffc107; --text-dark: #222;
            --bg-light: #f8f9fa; --white: #fff; --border-color: #dee2e6;
            --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.08); --border-radius: 6px;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--bg-light); color: var(--text-dark); direction: rtl; }
        #app-container { display: none; }
        header, nav { position: sticky; z-index: 1010; }
        header { background: var(--primary-color); color: var(--white); padding: 15px; text-align: center; font-size: 24px; display: flex; justify-content: space-between; align-items: center; top: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
        header > div { display: flex; gap: 10px; }
        nav { display: flex; background: var(--secondary-color); overflow-x: auto; top: 73px; }
        nav button { flex: 1 0 auto; padding: 12px 15px; border: none; background: var(--secondary-color); color: var(--white); font-size: 16px; cursor: pointer; transition: background 0.3s; white-space: nowrap; }
        nav button.active, nav button:hover { background: #0056b3; }
        main { padding: 15px; max-width: 900px; margin: auto; }
        section { display: none; }
        section.active { display: block; }
        input, select, button, table { font-size: 16px; }
        button { background: var(--primary-color); color: var(--white); border: none; padding: 10px 15px; border-radius: var(--border-radius); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: background 0.2s, transform 0.1s; }
        button:hover { background: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid var(--border-color); padding: 10px; text-align: center; vertical-align: middle; }
        th { background: #e9ecef; }
        .btn-small { padding: 5px 10px; font-size: 14px; margin: 0 2px; border-radius: 4px; }
        .btn-danger { background: var(--danger-color); }
        #notification-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; }
        .notification { background-color: rgba(0, 0, 0, 0.85); color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); margin-bottom: 10px; opacity: 0; transition: opacity 0.5s, transform 0.5s; transform: translateY(20px); }
        .notification.show { opacity: 1; transform: translateY(0); }
        #login-container { display: flex; align-items: center; justify-content: center; height: 100vh; }
        #login-form { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 350px; }
        #barcode-scanner-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1011; display: none; justify-content: center; align-items: flex-start; padding-top: 20px; }
        #reader { width: 90%; max-width: 350px; border: 3px solid var(--white); box-shadow: 0 0 0 2000px rgba(0,0,0,0.5); border-radius: var(--border-radius); overflow: hidden; }
        #closeScannerBtn { position: fixed; top: 15px; right: 15px; z-index: 1012; }
    </style>
</head>

<body>
    <div id="login-container"></div>
    <div id="app-container">
        <header>
            <span>الكاشير</span>
            <div>
                <button id="adminPanelBtn" title="لوحة تحكم المسؤول" style="background: var(--success-color); padding: 8px 12px;"><i class="fas fa-cog"></i></button>
                <button id="logoutBtn" title="خروج" style="padding: 8px 12px;"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>
        <nav>
            <button data-tab="sales" class="active"><i class="fas fa-cash-register"></i> المبيعات</button>
            <button id="itemsTabBtn" data-tab="items" style="display: none;"><i class="fas fa-box"></i> الأصناف</button>
        </nav>
        <main>
            <section id="sales" class="active"></section>
            <section id="items"></section>
        </main>
    </div>
    <div id="barcode-scanner-container">
        <div id="reader"></div>
        <button id="closeScannerBtn" class="btn-danger"><i class="fas fa-times"></i></button>
    </div>
    <div id="notification-container"></div>

    <script type="module">
        // --- Global App State ---
        const appState = {
            items: [],
            currentInvoice: [],
            adminPIN: "790707071",
            currentUser: null,
        };

        // --- DOM Elements & UI Helpers ---
        const DOM = {
            appContainer: document.getElementById("app-container"),
            loginContainer: document.getElementById("login-container"),
            logoutBtn: document.getElementById("logoutBtn"),
            nav: document.querySelector("nav"),
            navButtons: () => document.querySelectorAll("nav button"),
            sections: document.querySelectorAll("main section"),
            notificationContainer: document.getElementById("notification-container"),
            passwordInput: () => document.getElementById("passwordInput"),
        };

        const Helpers = {
            showNotification: (message, duration = 3000) => {
                const el = document.createElement("div"); el.className = "notification"; el.textContent = message;
                DOM.notificationContainer.appendChild(el);
                setTimeout(() => el.classList.add("show"), 10);
                setTimeout(() => { el.classList.remove("show"); setTimeout(() => el.remove(), 500); }, duration);
            },
            convertToArabicAndEnglishDigits: (text) => text ? text.toString().replace(/[٠-٩]/g, d => "٠١٢٣٤٥٦٧٨٩".indexOf(d)) : "",
            calculateChange: () => { /* الكود هنا كما هو */ },
            switchTab: (tabId) => {
                DOM.sections.forEach(s => s.classList.toggle("active", s.id === tabId));
                DOM.navButtons().forEach(b => b.classList.toggle("active", b.dataset.tab === tabId));
                const templates = {
                    sales: SalesController.getTemplate(),
                    items: ItemsController.getTemplate(),
                };
                const section = document.getElementById(tabId);
                if (section) section.innerHTML = templates[tabId] || '';
                if (tabId === 'sales') SalesController.init();
                if (tabId === 'items') ItemsController.init();
            }
        };

        // --- Controllers ---
        const Auth = {
            getTemplate: () => `<form id="login-form"><h2><i class="fas fa-lock"></i> تسجيل الدخول</h2><div class="form-group"><input type="password" id="passwordInput" placeholder="كلمة المرور" required /></div><button type="submit" id="loginBtn"><i class="fas fa-sign-in-alt"></i> دخول</button></form>`,
            login: (password) => {
                const pin = Helpers.convertToArabicAndEnglishDigits(password);
                if (pin === appState.adminPIN) {
                    appState.currentUser = { role: "admin" };
                    Auth.showApp();
                } else {
                    Helpers.showNotification("كلمة المرور غير صحيحة");
                }
            },
            logout: () => { location.reload(); },
            showApp: () => {
                DOM.loginContainer.style.display = "none";
                DOM.appContainer.style.display = "block";
                document.querySelector('[data-tab="sales"]').click();
            }
        };

        const ItemsController = {
            getTemplate: () => `<h2><i class="fas fa-box"></i> قائمة الأصناف</h2><table><thead><tr><th>باركود</th><th>اسم</th><th>سعر</th><th>فئة</th></tr></thead><tbody id="itemsTableBody"></tbody></table>`,
            init: () => ItemsController.render(),
            render: () => {
                const itemsTableBody = document.getElementById("itemsTableBody");
                if (itemsTableBody) itemsTableBody.innerHTML = appState.items.map(item => `<tr><td>${item.barcode || ''}</td><td>${item.name}</td><td>${(item.price || 0).toFixed(2)}</td><td>${item.category || ''}</td></tr>`).join("");
            }
        };

        const SalesController = { /* الكود هنا كما هو */ };

        const App = {
            init: async () => {
                DOM.loginContainer.innerHTML = Auth.getTemplate();
                App.bindEvents();
                try {
                    const GITHUB_BASE_URL = 'https://raw.githubusercontent.com/MahmoudAdelSaleh/Almas_Store/main/';
                    const fileNames = ['p1.json', 'p2.json', 'p3.json', 'p4.json', 'p5.json'];
                    
                    const fetchPromises = fileNames.map(fileName =>
                        fetch(GITHUB_BASE_URL + fileName)
                        .then(response => response.ok ? response.json() : null)
                        .catch(() => null)
                    );
                    const results = await Promise.all(fetchPromises);
                    const allItems = results.filter(Boolean).flat();
                    if (allItems.length === 0) {
                        throw new Error('لم يتم العثور على أي أصناف. تأكد من صحة رابط GitHub.');
                    }
                    appState.items = allItems.map(item => ({
                        id: item.barcode.toString(), barcode: item.barcode.toString(),
                        name: item.name, price: parseFloat(item.price) || 0,
                        category: item["category "]?.trim() || "غير مصنف",
                    }));
                    Helpers.showNotification(`تم تحميل ${appState.items.length} صنف بنجاح.`);
                } catch (error) {
                    Helpers.showNotification(error.message);
                }
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) { appState.currentUser = JSON.parse(savedUser); Auth.showApp(); }
            },
            bindEvents: () => {
                document.body.addEventListener('submit', e => {
                    if (e.target.id === 'login-form') { e.preventDefault(); Auth.login(DOM.passwordInput().value); }
                });
                DOM.logoutBtn.addEventListener("click", Auth.logout);

                // **تحسين مهم:** استخدام Event Delegation لضمان عمل الأزرار الجديدة
                if (DOM.nav) {
                    DOM.nav.addEventListener('click', e => {
                        const button = e.target.closest('button');
                        if (button && button.dataset.tab) {
                            Helpers.switchTab(button.dataset.tab);
                        }
                    });
                }
                
                const adminBtn = document.getElementById('adminPanelBtn');
                if (adminBtn) {
                    adminBtn.addEventListener('click', () => {
                        const pin = prompt("للوصول للوحة التحكم، أدخل الرقم السري للمسؤول:");
                        if (pin && Helpers.convertToArabicAndEnglishDigits(pin) === appState.adminPIN) {
                            const itemsTab = document.getElementById('itemsTabBtn');
                            if (itemsTab) {
                                itemsTab.style.display = 'flex';
                                Helpers.showNotification("تم فتح لوحة التحكم", 2000);
                                itemsTab.click();
                            }
                        } else if (pin !== null) {
                            Helpers.showNotification("رقم سري غير صحيح!");
                        }
                    });
                }
            }
        };

        App.init();
    </script>
</body>
</html>
